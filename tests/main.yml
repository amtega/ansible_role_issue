---
# Tasks for testing role

- name: Configure sandbox environment
  hosts: localhost
  roles:
    - role: amtega.docker_presets
      docker_presets_images_json_query: >-
        [? starts_with(name, `centos-6`)
           || starts_with(name, `centos-7`)
           || starts_with(name, `fedora-29`)
           || starts_with(name, `fedora-30`) ]
  tags:
    - sandbox

- name: Setup testing sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      docker_sandbox_state: started
  tags:
    - sandbox

- name: Test role amtega.issue
  hosts: docker_sandbox_containers
  roles:
    - amtega.issue
  vars:
    issue_message: This is the issue
    issue_net_message: Here is the issue on the net
  tasks:
    - name: Read /etc/issue file
      shell: cat /etc/issue
      changed_when: false
      register: read_issue_file_result

    - name: Read /etc/issue.net file
      shell: cat /etc/issue.net
      changed_when: false
      register: read_issue_net_file_result

    - name: Test /etc/issue
      assert:
        that:
          - read_issue_file_result.stdout == issue_message

    - name: Test /etc/issue
      assert:
        that:
          - read_issue_net_file_result.stdout == issue_net_message
  tags:
    - idempotence

- name: Cleanup testing sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      docker_sandbox_state: absent
  tags:
    - cleanup
    - sandbox
